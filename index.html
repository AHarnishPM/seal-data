<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Seal and Serpent Lineage Tracking Form</title>
    <!-- Include Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap">
    <!-- Treant.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css">
    <!-- Custom Styles -->
    <style>
        /* Your existing styles */
        body {
            font-family: 'Open Sans', Arial, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #FFF9C4;
            /* Light yellow background */
        }

        .container {
            max-width: 1200px;
            /* Increased max-width to make the container wider */
            margin: 0 auto;
            /* Center the container */
            padding: 20px;
            text-align: center;
            /* Center-align text */
        }

        h1 {
            color: #F57F17;
            /* Darker yellow/gold */
        }

        p {
            color: #555;
            /* Dark gray for readability */
            font-size: 18px;
            line-height: 1.6;
        }

        form {
            margin-top: 30px;
        }

        input {
            margin: 5px 0 15px 0;
            padding: 10px;
            width: 80%;
            max-width: 400px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        input::placeholder {
            color: #999;
        }

        button {
            padding: 12px 25px;
            margin-top: 20px;
            cursor: pointer;
            background-color: #FBC02D;
            /* Medium yellow */
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        button:hover {
            background-color: #F9A825;
            /* Darker yellow on hover */
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        /* Label Styles */
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
            text-align: left;
            width: 80%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Leaderboard Styles */
        #leaderboard {
            margin-top: 50px;
            text-align: center;
        }

        #leaderboard h2 {
            color: #F57F17;
        }

        #leaderboard table {
            margin: 0 auto;
            border-collapse: collapse;
            width: 80%;
            max-width: 600px;
            /* Increased max-width for the table */
            font-size: 18px;
        }

        #leaderboard th,
        #leaderboard td {
            border: 1px solid #ccc;
            padding: 10px;
        }

        #leaderboard th {
            background-color: #FBC02D;
            color: #fff;
        }

        /* Styles for gold, silver, and bronze rows */
        .gold {
            background-color: #FFD700;
            /* Gold color */
            color: #000;
        }

        .silver {
            background-color: #C0C0C0;
            /* Silver color */
            color: #000;
        }

        .bronze {
            background-color: #CD7F32;
            /* Bronze color */
            color: #000;
        }

        @media (max-width: 600px) {
            input {
                width: 100%;
            }

            label {
                width: 100%;
            }

            #leaderboard table {
                width: 100%;
            }

            #familyTree {
                width: 100%;
            }
        }

        /* Add margin to separate the submitter's name field */
        #submitterName {
            margin-top: 10px;
        }

        /* Search Section Styles */
        #searchSection {
            margin-top: 50px;
            text-align: center;
        }

        #searchSection h2 {
            color: #F57F17;
        }

        #searchResult {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }

        /* Family Tree Section Styles */
        #familyTreeSection {
            margin-top: 50px;
            text-align: center;
        }

        #familyTree {
            width: 100%;
            height: 1000px;
            overflow: hidden;
            /* keep this; Panzoom handles panning */
            border: 1px solid #ccc;
            margin: 0 auto;
            position: relative;
            /* IMPORTANT: allow normal page scroll unless user is inside the stage */
            overscroll-behavior: contain;
        }

        .Treant {
            position: relative;
            transform-origin: 0 0;
            /* IMPORTANT: touch gestures for Panzoom (pinch/drag) */
            touch-action: none;
            /* <- moved here from #familyTree */
            -ms-touch-action: none;
            /* older Edge */
        }

        .node {
            text-align: center;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            background-color: #FBC02D;
            color: #000;
            min-width: 100px;
            /* Ensure nodes have a minimum width */
            min-height: 50px;
            /* Ensure nodes have a minimum height */
            max-width: 200px;
            /* Optional: limit maximum width */
            word-wrap: break-word;
            /* Wrap long text */
        }

        .node-name {
            font-weight: bold;
            font-size: 14px;
            /* Reduced font size */
        }

        .node-title {
            font-size: 12px;
            color: #555;
        }

        /* Style for bigs not listed as members */
        .node-bigs-not-member {
            background-color: #2196F3;
            /* Blue background */
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Seal and Serpent Lineage Tracking Form</h1>
        <p>I created this form in an effort to track lineages back as far as possible and make some cool graphs of our
            society over time to share with actives and alumni. With a black book from around every other year, we can
            trace our entire lineage back to whenever we started keeping track.</p>
        <p>Please enter information for any members whom you know or have a black book containing, following the
            formatting outlined in grey inside the boxes.</p>
        <p>Enter your name in the first box to count towards the leaderboard. Use full, legal first and last names for
            all members and 4 digits for the year, as due to our age, we have members from 1927 and 2027.</p>
        <p>Thank you for helping! If you have any questions, email me at <a
                href="mailto:ajh374@cornell.edu">ajh374@cornell.edu</a></p>
        <p>- Aaron Harnish, 2027</p>

        <!-- Submitter's Name Field (Outside the Form) -->
        <label for="submitterName">Your Name:</label><br>
        <input type="text" id="submitterName" placeholder="Your Name (e.g., Edward Tinkham)" required><br>

        <!-- Member Form -->
        <form id="memberForm">
            <label for="memberName">Member's Name:</label><br>
            <input type="text" id="memberName" placeholder="Member's Name (e.g., Aaron Harnish)" required><br>
            <label for="gradYear">Member Graduation Year:</label><br>
            <input type="text" id="gradYear" placeholder="Member Graduation Year (e.g., 2027)" required><br>
            <label for="bigName">Member's Big's Name:</label><br>
            <input type="text" id="bigName" placeholder="Member's Big's Name (e.g., Cedric Orton-Urbina)" required><br>
            <button type="button" id="addEntryButton">Add Entry</button>
            <p id="message"></p>
        </form>

        <!-- Search Section -->
        <div id="searchSection">
            <h2>Search for a Member</h2>
            <input type="text" id="searchName" placeholder="Enter Member's Name to Search">
            <button type="button" id="searchButton">Search</button>
            <div id="searchResult"></div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard">
            <h2>Top Contributors</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Entries</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard entries will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Family Tree Section -->
        <div id="familyTreeSection">
            <h2>Family Tree</h2>
            <div id="familyTree">
                <!-- Panzoom controls (optional) -->
                <div id="treeControls"
                    style="position:absolute; top:10px; left:10px; z-index:1000; pointer-events:auto;">
                    <button id="zoomIn">Zoom In</button>
                    <button id="zoomOut">Zoom Out</button>
                    <button id="resetZoom">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Raphael.js before Treant.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <!-- Include Treant.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>
    <!-- Include Panzoom.js -->
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.1/dist/panzoom.min.js"></script>

    <!-- Firebase SDK and Your JavaScript Code -->
    <script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            addDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            startAt,
            endAt,
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "seal-data-collection.firebaseapp.com",
            projectId: "seal-data-collection",
            storageBucket: "seal-data-collection.appspot.com",
            messagingSenderId: "17642329541",
            appId: "1:17642329541:web:39d214d2f5c8b01ce2a7ac",
            measurementId: "G-BMCBQ5S8QV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Attach event listeners after the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", () => {
            // Retrieve and set the submitter's name from local storage if available
            const savedName = localStorage.getItem('submitterName');
            if (savedName) {
                document.getElementById("submitterName").value = savedName;
            } else {
                // Set default placeholder name
                document.getElementById("submitterName").placeholder = "Your Name (e.g., Aaron Harnish)";
            }
            document.getElementById("addEntryButton").addEventListener("click", addEntry);
            document.getElementById("searchButton").addEventListener("click", searchMember);
            // Load the leaderboard
            loadLeaderboard();
            // Load the family tree
            loadFamilyTree();
        });

        async function addEntry() {
            const memberName = document.getElementById("memberName").value.trim();
            const bigName = document.getElementById("bigName").value.trim();
            const gradYear = document.getElementById("gradYear").value.trim();
            const submitterName = document.getElementById("submitterName").value.trim();
            const message = document.getElementById("message");

            // Ensure all required fields are filled
            if (!memberName || !bigName || !gradYear || !submitterName) {
                message.textContent = "All fields are required.";
                message.className = "error";
                return;
            }

            // Validate that gradYear is a 4-digit number
            const gradYearPattern = /^\d{4}$/;
            if (!gradYearPattern.test(gradYear)) {
                message.textContent = "Graduation year must be a 4-digit number.";
                message.className = "error";
                return;
            }

            // Update name validation regex to allow letters, spaces, hyphens, and apostrophes
            const namePattern = /^[a-zA-Z\s'-]+$/;
            if (
                !namePattern.test(memberName) ||
                !namePattern.test(bigName) ||
                !namePattern.test(submitterName)
            ) {
                message.textContent = "Names can only contain letters, spaces, hyphens, and apostrophes.";
                message.className = "error";
                return;
            }

            // Save submitter's name to local storage
            localStorage.setItem('submitterName', submitterName);

            try {
                // Check for duplicates (ignore gradYear)
                const q = query(
                    collection(db, "mentorship"),
                    where("memberName", "==", memberName)
                );
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Duplicate found
                    message.textContent = "This member already exists.";
                    message.className = "error";
                    return;
                }

                // Add entry to Firestore
                await addDoc(collection(db, "mentorship"), {
                    memberName,
                    gradYear,
                    bigName,
                    submittedBy: submitterName,
                    timestamp: new Date()
                });

                message.textContent = "Entry added successfully!";
                message.className = "success";

                // Reset the form but not the submitter's name
                document.getElementById("memberForm").reset();

                // Reload the leaderboard to reflect the new entry
                loadLeaderboard();
                // Reload the family tree
                loadFamilyTree();

            } catch (error) {
                console.error("Error adding document:", error);
                message.textContent = "Failed to add entry.";
                message.className = "error";
            }
        }

        async function loadLeaderboard() {
            const leaderboardBody = document.getElementById("leaderboard-body");
            leaderboardBody.innerHTML = ""; // Clear existing entries

            try {
                // Fetch all entries from Firestore
                const entriesSnapshot = await getDocs(collection(db, "mentorship"));

                const submitterCounts = {};

                // Count entries per submitter
                entriesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const submitter = data.submittedBy || "Anonymous";

                    if (submitterCounts[submitter]) {
                        submitterCounts[submitter]++;
                    } else {
                        submitterCounts[submitter] = 1;
                    }
                });

                // Convert counts to an array and sort in descending order
                const sortedSubmitters = Object.entries(submitterCounts)
                    .sort((a, b) => b[1] - a[1]) // Sort by count descending
                    .slice(0, 7); // Get top 7

                // Build the leaderboard rows
                sortedSubmitters.forEach((entry, index) => {
                    const [name, count] = entry;
                    const row = document.createElement("tr");

                    const rankCell = document.createElement("td");
                    rankCell.textContent = index + 1;

                    const nameCell = document.createElement("td");
                    nameCell.textContent = name;

                    const countCell = document.createElement("td");
                    countCell.textContent = count;

                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(countCell);

                    // Add class to row based on rank
                    if (index === 0) {
                        row.classList.add("gold");
                    } else if (index === 1) {
                        row.classList.add("silver");
                    } else if (index === 2) {
                        row.classList.add("bronze");
                    }
                    // For ranks 4 to 7, no additional class (white background)

                    leaderboardBody.appendChild(row);
                });

            } catch (error) {
                console.error("Error loading leaderboard:", error);
            }
        }

        async function searchMember() {
            const searchName = document.getElementById("searchName").value.trim();
            const searchResult = document.getElementById("searchResult");

            if (!searchName) {
                searchResult.textContent = "Please enter a member's name to search.";
                return;
            }

            try {
                // Perform partial match search (case-sensitive)
                const q = query(
                    collection(db, "mentorship"),
                    orderBy("memberName"),
                    startAt(searchName),
                    endAt(searchName + '\uf8ff')
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    searchResult.textContent = "Member not found.";
                } else {
                    searchResult.innerHTML = "";
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const resultDiv = document.createElement("div");
                        resultDiv.innerHTML = `
                            <p><strong>Member Name:</strong> ${data.memberName}</p>
                            <p><strong>Graduation Year:</strong> ${data.gradYear}</p>
                            <p><strong>Big's Name:</strong> ${data.bigName}</p>
                            <p><strong>Submitted By:</strong> ${data.submittedBy}</p>
                        `;
                        searchResult.appendChild(resultDiv);
                    });
                }
            } catch (error) {
                console.error("Error searching for member:", error);
                searchResult.textContent = "An error occurred while searching.";
            }
        }

        // Function to load the family tree
        async function loadFamilyTree() {
            try {
                // Fetch all entries from Firestore
                const entriesSnapshot = await getDocs(collection(db, "mentorship"));
                const members = [];

                // Build an array of member objects
                entriesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    members.push({
                        memberName: data.memberName,
                        bigName: data.bigName,
                        gradYear: data.gradYear,
                    });
                });

                // Build the tree data
                const treeConfig = buildTreeConfig(members);

                // Clear any previous tree
                document.getElementById("familyTree").innerHTML = '';

                // Visualize the tree
                new Treant(treeConfig, function () {
                    // Initialize panzoom after the tree is loaded
                    initPanZoom();
                });

            } catch (error) {
                console.error("Error loading family tree:", error);
            }
        }

        // Function to build tree config for Treant.js
        function buildTreeConfig(members) {
            const memberMap = {};
            const nodes = {};
            const roots = [];

            // Create node configs for all members
            members.forEach(member => {
                memberMap[member.memberName] = member;
                nodes[member.memberName] = {
                    text: {
                        name: member.memberName,
                        title: "Grad Year: " + member.gradYear
                    },
                    HTMLclass: 'node',
                    children: []
                };
            });

            // Build the tree by linking nodes
            members.forEach(member => {
                const node = nodes[member.memberName];
                if (member.bigName) {
                    if (nodes[member.bigName]) {
                        // Big is a listed member
                        nodes[member.bigName].children.push(node);
                    } else {
                        // Big is not a listed member
                        // Create a node for the big with a different style
                        nodes[member.bigName] = {
                            text: {
                                name: member.bigName,
                                title: "Big (Not Listed)"
                            },
                            HTMLclass: 'node node-bigs-not-member',
                            children: [node]
                        };
                        // Add to roots since the big has no parent
                        roots.push(nodes[member.bigName]);
                    }
                } else {
                    // No big specified, add to roots
                    roots.push(node);
                }
            });

            // Remove duplicates from roots array
            const uniqueRoots = [...new Set(roots)];

            // If there's only one root, use it; otherwise, create a dummy root
            const chartConfig = {
                chart: {
                    container: "#familyTree",
                    rootOrientation: "NORTH", // Vertical orientation
                    levelSeparation: 50, // Increased separation to prevent overlap
                    siblingSeparation: 30,
                    subTeeSeparation: 50,
                    connectors: {
                        type: "step"
                    },
                    node: {
                        HTMLclass: "node",
                        collapsable: true
                    },
                    animation: {
                        nodeAnimation: "easeOutBounce",
                        nodeSpeed: 700,
                        connectorsAnimation: "bounce",
                        connectorsSpeed: 700
                    }
                },
                nodeStructure: {}
            };

            if (uniqueRoots.length === 1) {
                chartConfig.nodeStructure = uniqueRoots[0];
            } else {
                chartConfig.nodeStructure = {
                    text: { name: "Root" },
                    children: uniqueRoots,
                    HTMLclass: 'node'
                };
            }

            return chartConfig;
        }

        // Function to initialize panzoom
        function initPanZoom() {
            const viewport = document.getElementById('familyTree');
            const stage = viewport.querySelector('.Treant'); // Treant renders this inside #familyTree
            if (!stage) return;

            // Ensure the stage accepts touch gestures
            stage.style.touchAction = 'none';

            const panzoom = Panzoom(stage, {
                maxScale: 5,
                minScale: 0.4,
                contain: 'outside',
                cursor: 'grab',
                animate: true
            });

            // Drag-to-pan UX
            stage.addEventListener('pointerdown', () => {
                stage.style.cursor = 'grabbing';
            });
            stage.addEventListener('pointerup', () => {
                stage.style.cursor = 'grab';
            });
            stage.addEventListener('pointercancel', () => {
                stage.style.cursor = 'grab';
            });

            // Wheel zoom (desktop) â€” IMPORTANT: passive:false so we can prevent default
            viewport.addEventListener('wheel', (e) => {
                e.preventDefault();
                panzoom.zoomWithWheel(e);
            }, { passive: false });

            // Buttons
            document.getElementById('zoomIn').addEventListener('click', () => panzoom.zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => panzoom.zoomOut());
            document.getElementById('resetZoom').addEventListener('click', () => {
                panzoom.zoomTo(1);
                panzoom.pan(0, 0);
            });

            // Optional: start slightly zoomed out and center the tree
            requestAnimationFrame(() => {
                try {
                    panzoom.zoomTo(0.8);
                    // Center by panning to put stage roughly in the middle of the viewport
                    const vp = viewport.getBoundingClientRect();
                    const st = stage.getBoundingClientRect();
                    const dx = (vp.width - st.width) / 2;
                    const dy = (vp.height - st.height) / 2;
                    panzoom.pan(dx, dy);
                } catch { }
            });
        }
    </script>
</body>

</html>