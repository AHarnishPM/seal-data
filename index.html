<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seal and Serpent Lineage Tracker</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 
           Using Custom colors to match the original design:
           Background: #FFF9C4 (Light Yellow)
           Headings: #F57F17 (Dark Gold)
           Buttons/Nodes: #FBC02D (Medium Yellow)
        */

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #FFF9C4;
            /* Your original light yellow background */
            color: #333;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #FFF9C4;
        }

        ::-webkit-scrollbar-thumb {
            background: #FBC02D;
            border-radius: 4px;
        }

        h1 {
            color: #F57F17;
            /* Darker yellow/gold */
            font-weight: 700;
        }

        h2 {
            color: #F57F17;
            font-weight: 600;
        }

        /* Button Styles */
        .btn-gold {
            background-color: #FBC02D;
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-gold:hover {
            background-color: #F9A825;
            /* Darker yellow on hover */
        }

        /* Tree Container */
        #tree-container {
            background-color: #ffffff;
            /* White background for the tree area */
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            height: 80vh;
            width: 100%;
            overflow: hidden;
            /* Hide scrollbars, let D3 handle zoom/pan */
            position: relative;
            cursor: grab;
        }

        #tree-container:active {
            cursor: grabbing;
        }

        /* Leaderboard Colors */
        .gold {
            background-color: #FFD700 !important;
            color: #000;
        }

        .silver {
            background-color: #C0C0C0 !important;
            color: #000;
        }

        .bronze {
            background-color: #CD7F32 !important;
            color: #fff;
        }

        /* Input styling */
        input:focus {
            outline: 2px solid #FBC02D;
            border-color: #FBC02D;
        }

        /* Helper for the content boxes */
        .content-box {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Header -->
        <header class="text-center mb-10 max-w-3xl mx-auto">
            <h1 class="text-4xl md:text-5xl mb-6">Seal and Serpent Lineage Tracking Form</h1>
            <div class="space-y-4 text-gray-700 text-lg">
                <p>I created this form in an effort to track lineages back as far as possible and make some cool graphs
                    of our society over time to share with actives and alumni.</p>
                <p>Please enter information for any members whom you know or have a black book containing, following the
                    formatting outlined in grey inside the boxes.</p>
                <p>Enter your name in the first box to count towards the leaderboard. Use full, legal first and last
                    names for all members and 4 digits for the year.</p>
                <p class="text-sm">Thank you for helping! Questions? Email <a href="mailto:ajh374@cornell.edu"
                        class="text-blue-600 hover:underline">ajh374@cornell.edu</a></p>
                <p class="font-bold">- Aaron Harnish, 2027</p>
            </div>
        </header>

        <!-- Submitter Name (Global) -->
        <div class="max-w-xl mx-auto mb-8">
            <label for="submitterName" class="block text-gray-700 font-bold mb-2">Your Name (for Leaderboard):</label>
            <input type="text" id="submitterName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                placeholder="Your Name (e.g., Edward Tinkham)" required>
        </div>

        <!-- Add Entry Box -->
        <!-- Constrained to max-w-xl so it doesn't stretch across the screen -->
        <section class="content-box max-w-xl mx-auto">
            <h2 class="text-3xl text-center mb-6">Add New Entry</h2>
            <form id="memberForm" class="space-y-4">
                <div>
                    <label for="memberName" class="block text-gray-700 font-bold mb-1">Member's Name:</label>
                    <input type="text" id="memberName" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="Member's Name (e.g., Aaron Harnish)" required>
                </div>
                <div>
                    <label for="gradYear" class="block text-gray-700 font-bold mb-1">Graduation Year:</label>
                    <input type="text" id="gradYear" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="YYYY (e.g., 2027)" required>
                </div>
                <div>
                    <label for="bigName" class="block text-gray-700 font-bold mb-1">Member's Big's Name:</label>
                    <input type="text" id="bigName" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="Big's Name (e.g., Cedric Orton-Urbina)" required>
                </div>

                <button type="button" id="addEntryButton"
                    class="btn-gold w-full py-3 px-4 rounded-lg font-bold text-lg mt-4 shadow-md">Add Entry</button>
                <p id="message" class="text-center font-bold mt-2"></p>
            </form>
        </section>

        <!-- Search Box -->
        <section id="searchSection" class="content-box max-w-xl mx-auto">
            <h2 class="text-2xl text-center mb-4">Search for a Member</h2>
            <div class="space-y-4">
                <input type="text" id="searchName" class="w-full p-3 border border-gray-300 rounded-lg"
                    placeholder="Enter Name to Search">
                <button type="button" id="searchButton"
                    class="btn-gold w-full py-3 px-4 rounded-lg font-bold shadow-md">Search</button>
                <div id="searchResult" class="mt-4 text-left"></div>
            </div>
        </section>

        <!-- Leaderboard Box -->
        <section id="leaderboard" class="content-box max-w-3xl mx-auto">
            <h2 class="text-3xl text-center mb-6">Top Contributors</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-[#FBC02D] text-white">
                            <th class="p-3 border border-gray-200">Rank</th>
                            <th class="p-3 border border-gray-200">Name</th>
                            <th class="p-3 border border-gray-200">Entries</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-lg">
                        <!-- Entries inserted via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Family Tree Section -->
        <!-- This section is allowed to be wider (max-w-7xl) so the tree has room -->
        <section id="familyTreeSection" class="content-box w-full mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-3xl text-center md:text-left">Family Tree</h2>
                <div class="text-sm text-gray-500 mt-2 md:mt-0">
                    Scroll to Zoom â€¢ Drag to Pan
                </div>
            </div>

            <div id="tree-container"></div>
        </section>
    </div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://unpkg.com/d3-flextree@2.1.2/dist/d3-flextree.js"></script>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            addDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            startAt,
            endAt,
            limit,
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCoFenVip-lyHF3v6x7DAtrnR-KTVMlC6w", // <--- REPLACE WITH YOUR REAL API KEY
            authDomain: "seal-data-collection.firebaseapp.com",
            projectId: "seal-data-collection",
            storageBucket: "seal-data-collection.appspot.com",
            messagingSenderId: "17642329541",
            appId: "1:17642329541:web:39d214d2f5c8b01ce2a7ac",
            measurementId: "G-BMCBQ5S8QV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Init ---
        document.addEventListener("DOMContentLoaded", () => {
            const savedName = localStorage.getItem('submitterName');
            if (savedName) document.getElementById("submitterName").value = savedName;

            document.getElementById("addEntryButton").addEventListener("click", addEntry);
            document.getElementById("searchButton").addEventListener("click", searchMember);

            loadLeaderboard();
            loadFamilyTree();
        });

        // --- Actions ---
        async function addEntry() {
            const memberName = document.getElementById("memberName").value.trim();
            const bigName = document.getElementById("bigName").value.trim();
            const gradYear = document.getElementById("gradYear").value.trim();
            const submitterName = document.getElementById("submitterName").value.trim();
            const message = document.getElementById("message");

            if (!memberName || !bigName || !gradYear || !submitterName) {
                message.textContent = "All fields are required.";
                message.className = "text-red-600";
                return;
            }

            if (!/^\d{4}$/.test(gradYear)) {
                message.textContent = "Graduation year must be 4 digits.";
                message.className = "text-red-600";
                return;
            }

            const namePattern = /^[a-zA-Z\s'-]+$/;
            if (!namePattern.test(memberName) || !namePattern.test(bigName) || !namePattern.test(submitterName)) {
                message.textContent = "Names can only contain letters, spaces, hyphens.";
                message.className = "text-red-600";
                return;
            }

            localStorage.setItem('submitterName', submitterName);

            try {
                const q = query(collection(db, "mentorship"), where("memberName", "==", memberName));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    message.textContent = "Member already exists.";
                    message.className = "text-red-600";
                    return;
                }

                await addDoc(collection(db, "mentorship"), {
                    memberName, gradYear, bigName, submittedBy: submitterName, timestamp: new Date()
                });

                message.textContent = "Entry added!";
                message.className = "text-green-600";
                document.getElementById("memberForm").reset();
                loadLeaderboard();
                loadFamilyTree();

            } catch (error) {
                console.error(error);
                message.textContent = "Error adding entry.";
                message.className = "text-red-600";
            }
        }

        async function loadLeaderboard() {
            const tbody = document.getElementById("leaderboard-body");
            tbody.innerHTML = "";
            try {
                const snap = await getDocs(collection(db, "mentorship"));
                const counts = {};
                snap.forEach(d => {
                    const s = d.data().submittedBy || "Anonymous";
                    counts[s] = (counts[s] || 0) + 1;
                });

                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 7);

                sorted.forEach((item, idx) => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b border-gray-200";
                    if (idx === 0) tr.classList.add("gold");
                    else if (idx === 1) tr.classList.add("silver");
                    else if (idx === 2) tr.classList.add("bronze");
                    else tr.classList.add("bg-white");

                    tr.innerHTML = `
                        <td class="p-3 border-r border-gray-200">${idx + 1}</td>
                        <td class="p-3 border-r border-gray-200">${item[0]}</td>
                        <td class="p-3">${item[1]}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        async function searchMember() {
            const val = document.getElementById("searchName").value.trim();
            const res = document.getElementById("searchResult");
            res.innerHTML = "";
            if (!val) return;

            try {
                const q = query(collection(db, "mentorship"), orderBy("memberName"), startAt(val), endAt(val + '\uf8ff'), limit(10));
                const snap = await getDocs(q);
                if (snap.empty) {
                    res.innerHTML = "<p class='text-red-600'>Not found.</p>";
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();
                        res.innerHTML += `
                            <div class="p-3 bg-gray-50 border border-gray-200 rounded mb-2">
                                <p><strong>Name:</strong> ${d.memberName}</p>
                                <p><strong>Class:</strong> ${d.gradYear}</p>
                                <p><strong>Big:</strong> ${d.bigName}</p>
                                <p class="text-sm text-gray-500 mt-1">By: ${d.submittedBy}</p>
                            </div>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        // --- Tree Visualization ---
        async function loadFamilyTree() {
            const container = document.getElementById("tree-container");
            container.innerHTML = "";

            const snap = await getDocs(collection(db, "mentorship"));
            const raw = [];
            snap.forEach(d => raw.push(d.data()));

            const data = buildData(raw);
            if (!data) {
                container.innerHTML = "<div class='flex items-center justify-center h-full text-gray-500'>No data yet.</div>";
                return;
            }
            renderTree(data, container);
        }

        function buildData(members) {
            const map = new Map();
            members.forEach(m => map.set(m.memberName, {
                id: m.memberName, name: m.memberName, year: m.gradYear, big: m.bigName, children: []
            }));

            const roots = new Map(map);

            map.forEach(node => {
                if (node.big) {
                    const bigNode = map.get(node.big);
                    if (bigNode) {
                        bigNode.children.push(node);
                        roots.delete(node.id);
                    } else {
                        // Dummy big
                        const dummy = { id: node.big, name: node.big, year: 'N/A', big: null, children: [node], isDummy: true };
                        map.set(dummy.id, dummy);
                        roots.set(dummy.id, dummy);
                        roots.delete(node.id);
                    }
                }
            });

            const finalRoots = Array.from(roots.values());
            if (finalRoots.length === 0) return null;
            if (finalRoots.length === 1) return finalRoots[0];
            return { id: "Root", name: "Society", year: "", children: finalRoots, isRoot: true };
        }

        function renderTree(data, container) {
            if (!d3 || !d3.flextree) return;

            const w = container.clientWidth;
            const h = container.clientHeight;

            const svg = d3.select(container).append("svg").attr("width", w).attr("height", h);
            const g = svg.append("g");

            const layout = d3.flextree().nodeSize(d => [120, 200]).spacing((a, b) => a.path(b).length * 15);
            const root = d3.hierarchy(data);
            layout(root);

            // Calculate bounding box to center
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            root.each(d => {
                if (!d.data.isRoot) {
                    minX = Math.min(minX, d.x - 80);
                    maxX = Math.max(maxX, d.x + 80);
                    minY = Math.min(minY, d.y - 40);
                    maxY = Math.max(maxY, d.y + 40);
                }
            });

            const treeW = maxX - minX;
            const treeH = maxY - minY;
            const scale = Math.min(w / treeW, h / treeH, 1) * 0.9;
            const tx = (w - (minX + maxX) * scale) / 2 + (minX + maxX) * scale / 2 - (minX + maxX) / 2 * scale;
            // Simplified centering logic:
            const centerX = w / 2 - (minX + maxX) / 2 * scale;
            const centerY = h / 2 - (minY + maxY) / 2 * scale;

            const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", e => g.attr("transform", e.transform));
            svg.call(zoom).call(zoom.transform, d3.zoomIdentity.translate(centerX, centerY).scale(scale));

            // Links
            g.selectAll(".link").data(root.links()).enter().append("path")
                .attr("fill", "none").attr("stroke", "#999").attr("stroke-width", 2)
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

            // Nodes
            const nodes = g.selectAll(".node").data(root.descendants().filter(d => !d.data.isRoot))
                .enter().append("g")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            nodes.append("rect")
                .attr("x", -75).attr("y", -35).attr("width", 150).attr("height", 70)
                .attr("rx", 6).attr("ry", 6)
                .attr("fill", d => d.data.isDummy ? "#4299E1" : "#FBC02D") // Blue for missing bigs, Yellow for members
                .attr("stroke", "#333").attr("stroke-width", 1)
                .attr("class", "shadow");

            nodes.append("text").text(d => d.data.name)
                .attr("dy", "-0.2em").attr("text-anchor", "middle")
                .attr("font-weight", "bold").attr("font-size", "14px")
                .attr("fill", d => d.data.isDummy ? "#fff" : "#000");

            nodes.append("text").text(d => d.data.year === 'N/A' ? 'Unlisted Big' : d.data.year)
                .attr("dy", "1.2em").attr("text-anchor", "middle")
                .attr("font-size", "12px")
                .attr("fill", d => d.data.isDummy ? "#eee" : "#333");
        }
    </script>
</body>

</html>