<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seal and Serpent Lineage Tracking Form</title>
    <!-- Include Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap">
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Your existing styles */
        body {
            font-family: 'Open Sans', Arial, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #FFF9C4; /* Light yellow background */
        }
        /* ... existing styles ... */
        /* Family Tree Section Styles */
        #familyTreeSection {
            margin-top: 50px;
            text-align: center;
        }
        #familyTree {
            margin: 0 auto;
            width: 100%;
            overflow-x: auto;
        }
        #generatePDFButton {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #FBC02D;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #generatePDFButton:hover {
            background-color: #F9A825;
        }
        /* Family Tree Visualization Styles */
        .node circle {
            fill: #FBC02D;
            stroke: #555;
            stroke-width: 2px;
        }
        .node text {
            font: 14px sans-serif;
        }
        .link {
            fill: none;
            stroke: #555;
            stroke-width: 2px;
        }
        /* Add any additional styles here */
    </style>
</head>
<body>
    <div class="container">
        <h1>Seal and Serpent Lineage Tracking Form</h1>
        <!-- Your existing content -->
        <!-- ... existing paragraphs ... -->

        <!-- Submitter's Name Field (Outside the Form) -->
        <input type="text" id="submitterName" placeholder="Your Name (e.g., Edward Tinkham)" required><br>

        <!-- Member Form -->
        <form id="memberForm">
            <input type="text" id="memberName" placeholder="Member's Name (e.g., Aaron Harnish)" required><br>
            <input type="text" id="gradYear" placeholder="Member Graduation Year (e.g., 2027)" required><br>
            <input type="text" id="bigName" placeholder="Member's Big's Name (e.g., Cedric Orton-Urbina)" required><br>
            <button type="button" id="addEntryButton">Add Entry</button>
            <p id="message"></p>
        </form>

        <!-- Search Section -->
        <!-- ... existing search section ... -->

        <!-- Leaderboard Section -->
        <!-- ... existing leaderboard section ... -->

        <!-- Family Tree Section -->
        <div id="familyTreeSection">
            <h2>Family Tree</h2>
            <div id="familyTree"></div>
            <button id="generatePDFButton">Download Family Tree as PDF</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            addDoc,
            collection,
            query,
            where,
            getDocs,
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "seal-data-collection.firebaseapp.com",
            projectId: "seal-data-collection",
            storageBucket: "seal-data-collection.appspot.com",
            messagingSenderId: "17642329541",
            appId: "1:17642329541:web:39d214d2f5c8b01ce2a7ac",
            measurementId: "G-BMCBQ5S8QV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Attach the event listener to the button after the DOM is loaded
        document.addEventListener("DOMContentLoaded", () => {
            // Retrieve and set the submitter's name from local storage if available
            const savedName = localStorage.getItem('submitterName');
            if (savedName) {
                document.getElementById("submitterName").value = savedName;
            } else {
                // Set default placeholder name
                document.getElementById("submitterName").placeholder = "Your Name (e.g., Aaron Harnish)";
            }
            document.getElementById("addEntryButton").addEventListener("click", addEntry);
            document.getElementById("searchButton").addEventListener("click", searchMember);
            document.getElementById("generatePDFButton").addEventListener("click", generatePDF);
            // Load the leaderboard
            loadLeaderboard();
            // Load the family tree
            loadFamilyTree();
        });

        async function addEntry() {
            // Existing code for adding an entry...
            // After adding the entry, reload the family tree
            loadFamilyTree();
        }

        // Existing functions: loadLeaderboard(), searchMember()

        // Function to load the family tree
        async function loadFamilyTree() {
            try {
                // Fetch all entries from Firestore
                const entriesSnapshot = await getDocs(collection(db, "mentorship"));
                const members = [];

                // Build an array of member objects
                entriesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    members.push({
                        memberName: data.memberName,
                        bigName: data.bigName,
                        gradYear: data.gradYear,
                    });
                });

                // Build the tree data
                const treeData = buildTreeData(members);

                // Visualize the tree
                visualizeTree(treeData);

            } catch (error) {
                console.error("Error loading family tree:", error);
            }
        }

        // Function to build tree data
        function buildTreeData(members) {
            // Create a map for easy lookup
            const memberMap = {};
            members.forEach(member => {
                memberMap[member.memberName] = { ...member, children: [] };
            });

            const roots = [];

            // Build the tree
            members.forEach(member => {
                if (member.bigName && memberMap[member.bigName]) {
                    memberMap[member.bigName].children.push(memberMap[member.memberName]);
                } else {
                    // If no big found, this is a root member
                    roots.push(memberMap[member.memberName]);
                }
            });

            // If there's only one root, return it; otherwise, create a dummy root
            if (roots.length === 1) {
                return roots[0];
            } else {
                return { memberName: "Root", children: roots };
            }
        }

        // Function to visualize the tree using D3.js
        function visualizeTree(treeData) {
            // Clear previous visualization
            d3.select("#familyTree").selectAll("*").remove();

            // Set the dimensions and margins of the diagram
            const margin = { top: 20, right: 90, bottom: 30, left: 90 },
                  width = 960 - margin.left - margin.right,
                  height = 600 - margin.top - margin.bottom;

            // Append the svg object to the #familyTree div
            const svg = d3.select("#familyTree").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const root = d3.hierarchy(treeData, function(d) {
                return d.children;
            });

            // Assigns the x and y position for the nodes
            const treeLayout = d3.tree().size([height, width]);
            treeLayout(root);

            // Adds the links between the nodes
            svg.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal()
                    .x(function(d) { return d.y; })
                    .y(function(d) { return d.x; }));

            // Adds each node as a group
            const node = svg.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", function(d) { 
                    return "node" + (d.children ? " node--internal" : " node--leaf"); })
                .attr("transform", function(d) { 
                    return "translate(" + d.y + "," + d.x + ")"; });

            // Adds the circle to the node
            node.append("circle")
                .attr("r", 10);

            // Adds the text to the node
            node.append("text")
                .attr("dy", ".35em")
                .attr("x", function(d) { 
                    return d.children ? -13 : 13; })
                .style("text-anchor", function(d) { 
                    return d.children ? "end" : "start"; })
                .text(function(d) { return d.data.memberName; });
        }

        // Function to generate PDF
        async function generatePDF() {
            const familyTreeElement = document.getElementById("familyTreeSection");
            // Use html2canvas to capture the family tree section
            const canvas = await html2canvas(familyTreeElement, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            // Create a new jsPDF instance
            const pdf = new jsPDF.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });

            // Add the image to the PDF
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);

            // Save the PDF
            pdf.save('family_tree.pdf');
        }

        // Existing functions: searchMember()
    </script>
</body>
</html>