<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seal and Serpent Lineage Tracker</title>
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 
           Background: #FFF9C4 (Light Yellow)
           Headings: #F57F17 (Dark Gold)
           Buttons/Nodes: #FBC02D (Medium Yellow)
        */
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #FFF9C4;
            color: #333;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #FFF9C4;
        }

        ::-webkit-scrollbar-thumb {
            background: #FBC02D;
            border-radius: 4px;
        }

        h1,
        h2 {
            color: #F57F17;
        }

        h1 {
            font-weight: 700;
        }

        h2 {
            font-weight: 600;
        }

        /* Gold Button Style */
        .btn-gold {
            background-color: #FBC02D;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-gold:hover {
            background-color: #F9A825;
        }

        /* Tree Container */
        #tree-container {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            height: 80vh;
            /* Responsive height */
            width: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
            touch-action: none;
            /* Prevents page scrolling on mobile while dragging tree */
        }

        #tree-container:active {
            cursor: grabbing;
        }

        /* Leaderboard Colors */
        .gold {
            background-color: #FFD700 !important;
            color: #000;
        }

        .silver {
            background-color: #C0C0C0 !important;
            color: #000;
        }

        .bronze {
            background-color: #CD7F32 !important;
            color: #fff;
        }

        /* Form Inputs */
        input:focus {
            outline: 2px solid #FBC02D;
            border-color: #FBC02D;
        }

        /* Card Style */
        .content-box {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Header -->
        <header class="text-center mb-10 max-w-3xl mx-auto">
            <h1 class="text-4xl md:text-5xl mb-6">Seal and Serpent Lineage Tracking Form</h1>
            <div class="space-y-4 text-gray-700 text-lg">
                <p>I created this form in an effort to track lineages back as far as possible and make some cool graphs
                    of our society over time to share with actives and alumni.</p>
                <p>Please enter information for any members whom you know or have a black book containing, following the
                    formatting outlined in grey inside the boxes.</p>
                <p>Enter your name in the first box to count towards the leaderboard. Use full, legal first and last
                    names for all members and 4 digits for the year.</p>
                <p class="text-sm">Thank you for helping! Questions? Email <a href="mailto:ajh374@cornell.edu"
                        class="text-blue-600 hover:underline">ajh374@cornell.edu</a></p>
                <p class="font-bold">- Aaron Harnish, 2027</p>
            </div>
        </header>

        <!-- Submitter Name -->
        <div class="max-w-xl mx-auto mb-8">
            <label for="submitterName" class="block text-gray-700 font-bold mb-2">Your Name (for Leaderboard):</label>
            <input type="text" id="submitterName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"
                placeholder="Your Name (e.g., Edward Tinkham)" required>
        </div>

        <!-- Add Entry Form -->
        <section class="content-box max-w-xl mx-auto">
            <h2 class="text-3xl text-center mb-6">Add New Entry</h2>
            <form id="memberForm" class="space-y-4">
                <div>
                    <label for="memberName" class="block text-gray-700 font-bold mb-1">Member's Name:</label>
                    <input type="text" id="memberName" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="Member's Name (e.g., Aaron Harnish)" required>
                </div>
                <div>
                    <label for="gradYear" class="block text-gray-700 font-bold mb-1">Graduation Year:</label>
                    <input type="text" id="gradYear" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="YYYY (e.g., 2027)" required>
                </div>
                <div>
                    <label for="bigName" class="block text-gray-700 font-bold mb-1">Member's Big's Name:</label>
                    <input type="text" id="bigName" class="w-full p-3 border border-gray-300 rounded-lg"
                        placeholder="Big's Name (e.g., Cedric Orton-Urbina)" required>
                </div>

                <button type="button" id="addEntryButton"
                    class="btn-gold w-full py-3 px-4 rounded-lg font-bold text-lg mt-4 shadow-md">Add Entry</button>
                <p id="message" class="text-center font-bold mt-2"></p>
            </form>
        </section>

        <!-- Family Tree Section (Moved UP) -->
        <section id="familyTreeSection" class="content-box w-full mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-3xl text-center md:text-left">Family Tree</h2>
                <div class="text-sm text-gray-500 mt-2 md:mt-0">
                    Scroll to Zoom â€¢ Drag to Pan
                </div>
            </div>

            <div id="tree-container" class="flex items-center justify-center">
                <span class="text-gray-400">Loading Tree...</span>
            </div>
        </section>

        <!-- Search Box (Moved DOWN) -->
        <section id="searchSection" class="content-box max-w-xl mx-auto">
            <h2 class="text-2xl text-center mb-4">Search for a Member</h2>
            <div class="space-y-4">
                <input type="text" id="searchName" class="w-full p-3 border border-gray-300 rounded-lg"
                    placeholder="Enter Name to Search">
                <button type="button" id="searchButton"
                    class="btn-gold w-full py-3 px-4 rounded-lg font-bold shadow-md">Search</button>
                <div id="searchResult" class="mt-4 text-left space-y-3"></div>
            </div>
        </section>

        <!-- Leaderboard (Moved DOWN) -->
        <section id="leaderboard" class="content-box max-w-3xl mx-auto">
            <h2 class="text-3xl text-center mb-6">Top Contributors</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-[#FBC02D] text-white">
                            <th class="p-3 border border-gray-200">Rank</th>
                            <th class="p-3 border border-gray-200">Name</th>
                            <th class="p-3 border border-gray-200">Entries</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-lg">
                        <!-- Entries inserted via JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- D3.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            addDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            startAt,
            endAt,
            limit,
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCoFenVip-lyHF3v6x7DAtrnR-KTVMlC6w", // <--- REPLACE THIS WITH YOUR API KEY
            authDomain: "seal-data-collection.firebaseapp.com",
            projectId: "seal-data-collection",
            storageBucket: "seal-data-collection.appspot.com",
            messagingSenderId: "17642329541",
            appId: "1:17642329541:web:39d214d2f5c8b01ce2a7ac",
            measurementId: "G-BMCBQ5S8QV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables for D3 zoom control
        let globalSvg = null;
        let globalZoom = null;

        // --- MAIN LOGIC ---
        document.addEventListener("DOMContentLoaded", () => {
            console.log("[Lineage App] App initialized.");

            // Restore name
            const savedName = localStorage.getItem('submitterName');
            if (savedName) document.getElementById("submitterName").value = savedName;

            // Bind buttons
            document.getElementById("addEntryButton").addEventListener("click", addEntry);
            document.getElementById("searchButton").addEventListener("click", searchMember);

            // Load data
            loadLeaderboard();
            loadFamilyTree();
        });

        // 1. ADD ENTRY
        async function addEntry() {
            const memberName = document.getElementById("memberName").value.trim();
            const bigName = document.getElementById("bigName").value.trim();
            const gradYear = document.getElementById("gradYear").value.trim();
            const submitterName = document.getElementById("submitterName").value.trim();
            const message = document.getElementById("message");

            // Validation
            if (!memberName || !bigName || !gradYear || !submitterName) {
                message.textContent = "All fields are required.";
                message.className = "text-red-600";
                return;
            }
            if (!/^\d{4}$/.test(gradYear)) {
                message.textContent = "Graduation year must be 4 digits.";
                message.className = "text-red-600";
                return;
            }
            const namePattern = /^[a-zA-Z\s'-]+$/;
            if (!namePattern.test(memberName) || !namePattern.test(bigName) || !namePattern.test(submitterName)) {
                message.textContent = "Names can only contain letters, spaces, hyphens.";
                message.className = "text-red-600";
                return;
            }

            localStorage.setItem('submitterName', submitterName);

            try {
                // Check duplicate
                const q = query(collection(db, "mentorship"), where("memberName", "==", memberName));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    message.textContent = "Member already exists.";
                    message.className = "text-red-600";
                    return;
                }

                // Add
                await addDoc(collection(db, "mentorship"), {
                    memberName, gradYear, bigName, submittedBy: submitterName, timestamp: new Date()
                });

                message.textContent = "Entry added!";
                message.className = "text-green-600";
                document.getElementById("memberForm").reset();

                // Refresh views
                loadLeaderboard();
                loadFamilyTree();

            } catch (error) {
                console.error("[Lineage App] Add Error:", error);
                message.textContent = "Error adding entry. Check console.";
                message.className = "text-red-600";
            }
        }

        // 2. LEADERBOARD
        async function loadLeaderboard() {
            const tbody = document.getElementById("leaderboard-body");
            tbody.innerHTML = "";
            try {
                const snap = await getDocs(collection(db, "mentorship"));
                const counts = {};
                snap.forEach(d => {
                    const s = d.data().submittedBy || "Anonymous";
                    counts[s] = (counts[s] || 0) + 1;
                });

                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 7);

                sorted.forEach((item, idx) => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b border-gray-200";
                    if (idx === 0) tr.classList.add("gold");
                    else if (idx === 1) tr.classList.add("silver");
                    else if (idx === 2) tr.classList.add("bronze");
                    else tr.classList.add("bg-white");

                    tr.innerHTML = `
                        <td class="p-3 border-r border-gray-200">${idx + 1}</td>
                        <td class="p-3 border-r border-gray-200">${item[0]}</td>
                        <td class="p-3">${item[1]}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error("[Lineage App] Leaderboard Error:", e); }
        }

        // 3. SEARCH (Updated with Zoom Button)
        async function searchMember() {
            const val = document.getElementById("searchName").value.trim();
            const res = document.getElementById("searchResult");
            res.innerHTML = "";
            if (!val) return;

            try {
                const q = query(collection(db, "mentorship"), orderBy("memberName"), startAt(val), endAt(val + '\uf8ff'), limit(10));
                const snap = await getDocs(q);
                if (snap.empty) {
                    res.innerHTML = "<p class='text-red-600'>Not found.</p>";
                } else {
                    snap.forEach(doc => {
                        const d = doc.data();

                        // Create card element
                        const card = document.createElement('div');
                        card.className = "p-3 bg-gray-50 border border-gray-200 rounded shadow-sm";

                        // Text Info
                        card.innerHTML = `
                            <p><strong>Name:</strong> ${d.memberName}</p>
                            <p><strong>Class:</strong> ${d.gradYear}</p>
                            <p><strong>Big:</strong> ${d.bigName}</p>
                            <p class="text-sm text-gray-500 mt-1">By: ${d.submittedBy}</p>
                        `;

                        // "Locate in Tree" Button
                        const locateBtn = document.createElement('button');
                        locateBtn.textContent = "Locate in Tree";
                        locateBtn.className = "mt-2 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition";
                        locateBtn.onclick = () => zoomToMember(d.memberName);

                        card.appendChild(locateBtn);
                        res.appendChild(card);
                    });
                }
            } catch (e) { console.error("[Lineage App] Search Error:", e); }
        }

        // 4. ZOOM TO MEMBER LOGIC
        function zoomToMember(name) {
            if (!globalSvg || !globalZoom) {
                alert("Tree not loaded yet.");
                return;
            }

            // Find the node datum matching the name
            // We select all groups with class 'node' and filter data
            let targetNode = null;
            d3.selectAll(".node").each(function (d) {
                if (d.data.name === name) {
                    targetNode = d;
                }
            });

            if (targetNode) {
                const container = document.getElementById("tree-container");
                const w = container.clientWidth;
                const h = container.clientHeight;

                // Zoom Level 2x
                const scale = 2;
                // Center calculations
                // The transform translates to center (w/2, h/2), then subtracts the scaled node position
                const tx = (w / 2) - (targetNode.x * scale);
                const ty = (h / 2) - (targetNode.y * scale);

                // Animate the transition
                globalSvg.transition()
                    .duration(1000)
                    .call(globalZoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));

                // Optional: Highlight the node visually temporarily
                d3.selectAll(".node rect")
                    .attr("stroke", "#333")
                    .attr("stroke-width", 1); // Reset others

                d3.selectAll(".node").filter(d => d.data.name === name).select("rect")
                    .transition().duration(500)
                    .attr("stroke", "#EF4444") // Tailwind Red-500
                    .attr("stroke-width", 4)
                    .transition().delay(2000).duration(500)
                    .attr("stroke", "#333")
                    .attr("stroke-width", 1);

                // Scroll page to tree section
                document.getElementById("familyTreeSection").scrollIntoView({ behavior: 'smooth' });

            } else {
                alert(`Member "${name}" found in search but not visible in the current tree structure.`);
            }
        }

        // 5. FAMILY TREE
        async function loadFamilyTree() {
            const container = document.getElementById("tree-container");

            try {
                const snap = await getDocs(collection(db, "mentorship"));
                if (snap.empty) {
                    container.innerHTML = "<div class='text-gray-500 p-10'>No members found in database yet. Add one!</div>";
                    return;
                }

                const raw = [];
                snap.forEach(d => raw.push(d.data()));
                const data = buildData(raw);
                container.innerHTML = "";
                renderTree(data, container);

            } catch (error) {
                console.error("[Lineage App] Tree Load Error:", error);
                container.innerHTML = "<div class='text-red-500 p-10'>Error loading tree. Check console.</div>";
            }
        }

        function buildData(members) {
            const map = new Map();
            members.forEach(m => map.set(m.memberName, {
                id: m.memberName, name: m.memberName, year: m.gradYear, big: m.bigName, children: []
            }));
            const roots = new Map(map);
            map.forEach(node => {
                if (node.big) {
                    const bigNode = map.get(node.big);
                    if (bigNode) {
                        bigNode.children.push(node);
                        roots.delete(node.id);
                    } else {
                        if (map.has(node.big)) {
                            map.get(node.big).children.push(node);
                        } else {
                            const dummy = { id: node.big, name: node.big, year: 'N/A', big: null, children: [node], isDummy: true };
                            map.set(dummy.id, dummy);
                            roots.set(dummy.id, dummy);
                        }
                        roots.delete(node.id);
                    }
                }
            });
            const finalRoots = Array.from(roots.values());
            if (finalRoots.length === 1) return finalRoots[0];
            return { id: "Root", name: "Society", year: "", children: finalRoots, isRoot: true };
        }

        function renderTree(data, container) {
            const w = container.clientWidth;
            const h = container.clientHeight;

            // Assign to global variable for the Zoom function to use later
            globalSvg = d3.select(container).append("svg")
                .attr("width", w)
                .attr("height", h)
                .style("touch-action", "none");

            const g = globalSvg.append("g");

            const treeLayout = d3.tree().nodeSize([200, 120]);
            const root = d3.hierarchy(data);
            treeLayout(root);

            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            root.each(d => {
                if (d.x < minX) minX = d.x;
                if (d.x > maxX) maxX = d.x;
                if (d.y < minY) minY = d.y;
                if (d.y > maxY) maxY = d.y;
            });

            const treeWidth = maxX - minX;
            const treeHeight = maxY - minY;
            const midX = (minX + maxX) / 2;
            const midY = (minY + maxY) / 2;

            let scale = Math.min(w / (treeWidth + 200), h / (treeHeight + 200));
            if (scale > 1) scale = 1;
            if (scale < 0.2) scale = 0.2;

            const initialTransform = d3.zoomIdentity
                .translate(w / 2, 50)
                .scale(scale)
                .translate(-midX, -minY);

            // Assign to global variable
            globalZoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (e) => {
                    g.attr("transform", e.transform);
                });

            globalSvg.call(globalZoom)
                .call(globalZoom.transform, initialTransform);

            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("fill", "none")
                .attr("stroke", "#999")
                .attr("stroke-width", 2)
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

            const nodes = g.selectAll(".node")
                .data(root.descendants().filter(d => !d.data.isRoot))
                .enter().append("g")
                .attr("class", "node") // Important class for selector
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .style("cursor", "pointer");

            nodes.append("rect")
                .attr("x", -85)
                .attr("y", -35)
                .attr("width", 170)
                .attr("height", 70)
                .attr("rx", 8)
                .attr("ry", 8)
                .attr("fill", d => d.data.isDummy ? "#4299E1" : "#FBC02D")
                .attr("stroke", "#333")
                .attr("stroke-width", 1)
                .style("filter", "drop-shadow(2px 2px 2px rgba(0,0,0,0.2))");

            nodes.append("text")
                .attr("dy", "-0.2em")
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .attr("fill", d => d.data.isDummy ? "white" : "black")
                .text(d => d.data.name);

            nodes.append("text")
                .attr("dy", "1.2em")
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .attr("fill", d => d.data.isDummy ? "#eee" : "#444")
                .text(d => d.data.year === 'N/A' ? 'Unlisted Big' : `Class of ${d.data.year}`);
        }
    </script>
</body>

</html>